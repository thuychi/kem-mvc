var fs = require('fs'), 
	querystring = require('querystring'),
	html = fs.readFileSync(require('../../index.js').define.single_page, "utf8").replace(/[\r\t\n]/g, ""),
	re = /\{\{(.+?)\}\}/g, 
	reExp = /(^( )?(var|if|for|else|else\sif|{|}|;|\(|\)))(.*)?/g, 
	code = "with(obj) { var r=[];", 
	cursor = 0,
	add = function(line, js) {
		js?(code += line.match(reExp) ? line : "r.push(" + line + ");") :
			(code += line != "" ? "r.push('" + line.replace(/'/g, '"') + "');" : "");
		return add;
	};

while(match = re.exec(html)) {
	add(html.slice(cursor, match.index))(match[1], true);
	cursor = match.index + match[0].length;
};

add(html.substr(cursor, html.length - cursor));

var fn = new Function('obj', code + "return r.join(''); }");

module.exports = function middleware(req, res){
	res.writeHead(200, { 'Content-Type': 'text/html' });
	res.end(fn({
		cookie: querystring.parse(req.headers.cookie, '; '),
		query: querystring.parse(req.url).query
	}));
}