/**
 *	class AccountController {
 *		get(reply, action){
 *			//	action = 'login' | 'register'
 *			//	reply = class Reply
 *			reply.json({name: 'Thuan'});
 *			reply.html('index.index', {age: 25, name: 'Nguyen Thuan'});
 *		}
 *		post(){}
 *		put(){}
 *		delete(){}
 *	}
 *	app.router('/account/(login|register)', load.controller('account'));
 */

var querystring = require('querystring'),
	url = require('url'),
	app = require('../../index.js'), routes = app.routes, 
	Reply = require('../../mvc/controller'), 
	reply, router, parse_url, method, controller;

module.exports = function MicroServer(req, res){
	parse_url = url.parse(req.url);

	for(var i = 0, n = routes.length; i < n; i++){
		router = routes[i];

		if(m = router.uri.exec(parse_url.pathname)){
			method = req.method.toLowerCase();
			controller = new router.fn();

			if('get' === method){
				m[0] = new Reply(req, res, querystring.parse(parse_url.query));
				controller.get.apply(null, m);
			}else{
				var buffer_array = [];
				req.on('data', function(buffer){ buffer_array.push(buffer) });
				req.on('end', function(){
					m[0] = new Reply(req, res, querystring.parse(parse_url.query), Buffer.concat(buffer_array));
					controller[method].apply(null, m);
				});
			}
			return;
		}
	}

	return app._error ? app._error(req, res) : res.end();
}