var fs = require('fs'),
	url = require('url'),
	querystring = require('querystring'),
	Response = require('../../mvc/controller.js'),

	ListController = {},
	dirname = require('../../index.js').define.app.replace(/\/$/, '') + '/controller/',
	files = fs.readdirSync(dirname),
	response_error = new Buffer(JSON.stringify({ error: true, message: null })),
	fn = null,

	parse_url,
	param,
	method,
	controller,
	action;

for(var i = 0, n = files.length; i < n; i++){
	ListController[files[i].slice(0, -3)] = new (require(dirname + files[i]))();
}

module.exports = function callback(req, res){

	parse_url = url.parse(req.url);
	param = parse_url.pathname.substr(1).split('/');
	controller = ListController[param.shift() || 'index'];

	if(!controller) return res.end();
	
	method = req.method.toLowerCase();
	action = param[0] || 'index' || 'match';

	if('get' === method){
		if(fn = controller[action]){
			param[0] = new Response(req, res, querystring.parse(parse_url.query));

			if('match'===action) param.push(param[0]);
			
			fn.apply(null, param);
		}else{
			res.end();
		}
	}else{
		action = [method, action].join('_');

		if(fn = controller[action]){
			var array_buffer = [];

			req.on('data', function (buffer) {
				array_buffer.push(buffer);
			});
			req.on('end', function () {
				param[0] = new Response(req, res, querystring.parse(parse_url.query), Buffer.concat(array_buffer));
				fn.apply(null, param);
			});
		}else{
			res.end();
		}
	}
}