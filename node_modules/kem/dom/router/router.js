var DOM = require('../lib/dom.js'),
    App = document.getElementById('app');

module.exports = class Router extends DOM {

	componentWillMount() {
		var routes = this.props.children,
		    count = routes.length,
		    r = null,
		    route;

		function popstate(pathname) {

			for (var i = 0; i < count; i++) {
				route = routes[i];

				if (r = route.match.exec(pathname)) {

					var controller = new route.controller();

					App.replaceChild(controller.done, App.childNodes[0]);

					if (route.action) controller._parse_action(route.action, r.slice(1));
					else controller._parse_action(r[1], r.slice(2));

					return;
				}
			}

			App.replaceChild(DOM.createElement(
				'div',
				null,
				'This page not found'
			), App.childNodes[0]);
		}

		this.on('render', function (pathname) {
			window.history.pushState(null, null, pathname);
			popstate(pathname);
		});

		window.addEventListener('popstate', function (e) {
			popstate(window.location.pathname);
		});
	}
	render() {
		App.appendChild(new Comment());
		return App;
	}
}